#!/usr/bin/env node

var program = require('commander');
var Prompt = require('../lib/prompt');
var Slack = require('../lib/slack');
var SlackPublicAPI = require('../lib/slack_public_api');
var Pack = require('../lib/pack');
var co = require('co');


/**
 * Usage.
 */

program
  .version(require('../package').version)
  .option('-d, --debug', 'Run in debug mode')
  .option('-s, --subdomain [value]', 'Your Slack subdomain')
  .option('-e, --email [value]', 'Admin email address')
  .option('-p, --password [value]', 'Password for admin email')
  .option('-y, --pack [value]', 'YAML emoji pack')
  .option('--member_avatars', 'Will create emoji from your team users avatars. This option will ask for a token if not specified with -t')
  .option('-t, --token [value]', 'Slack Public API token')
  .parse(process.argv);

/**
 * Start process.
 */

co(function *() {
  const userArgs = yield Prompt.start(program.subdomain, program.email, program.password, program.pack, program.member_avatars, program.token);
  const token = userArgs.token;
  var user = userArgs.load;

  if (program.member_avatars !== true) {
    var pack = yield Pack.get(user.pack);
    var slack;

    pack = clean(pack);
    user.emojis = pack.emojis;
    slack = new Slack(user, program.debug);
    console.log("Uploading pack: ", user.pack);
    yield slack.import();
  } else {
    var slack;
    const slackPublicAPI = new SlackPublicAPI(token);
    const emojipack = yield slackPublicAPI.getUsernamesWithAvatar();

    memberEmojisDisclaimer()
    user.emojis = emojipack
    slack = new Slack(user, program.debug);

    yield slack.import();
  }
  
  process.exit();
});

/**
 * Standardize the emoji file.
 */

function clean(object) {
  if (!object.emojis) {
    object.emojis = [];
    for (var i = 0; i < object.length; i++) {
      if (!object[i].src) object[i].src = object[i].image_url;
      object.emojis.push(object[i]);
    }
  }
  return object;
}

/**
 * Standardize the emoji file.
 */

function memberEmojisDisclaimer() {
  console.log(`\n\nThis script doesn\'t override any existing emojis. \n\
If you want to update your membermojis you have to remove manually the old ones and re-run the script. \n\
Link: ${program.subdomain}.slack.com/customize/emoji \n\n`);
}